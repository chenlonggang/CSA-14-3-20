#include<stdlib.h>
#include<string.h>
#include"CSA.h"
#include<fstream>
#include<iostream>
using namespace std;
void usage();
void helpbuild();
void helpload();
void helpwrite();
void helpcount();
void helplocate();
void splitcommand(string command,string result[]);
void showpos(int * pos,int num);
int main(int argc, char* argv[])
{
	usage();
	string command;
	string  result[3];
	char filename[100]={'\0'};
	char pattern[100]={'\0'};
	char indexname[100]={'\0'};
	CSA *csa=NULL;
	while(1)
	{
		result[0]="";
		result[1]="";
		result[2]="";
		command="";
		cout<<">";
		getline(cin,command);
		splitcommand(command,result);
		if(result[0]=="quit")
			break;
		else if(result[0]=="build")
		{
			for(int i=0;i<result[1].length();i++)
				filename[i]=result[1].at(i);
			csa=new CSA(filename);
		}
		else if(result[0]=="count")
		{
			int num=0;
			for(int i=0;i<result[1].length();i++)
				pattern[i]=result[1].at(i);
			if(csa!=NULL)
			{
				csa->Counting(pattern,num);
				cout<<"occs: "<<num<<endl;
			}
			else
			{
				cout<<"build a csa first"<<endl;
			}
		}
		else if(result[0]=="locate")
		{
			int * pos;
			int num=0;
			for(int i=0;i<result[1].length();i++)
				pattern[i]=result[1].at(i);
			if(csa!=NULL)
			{
				csa->locating(pattern,num,pos);
				showpos(pos,num);
				delete [] pos;
			}
			else
				cout<<"build a csa first"<<endl;
		}
		else if(result[0]=="del")
		{
			if(csa!=NULL)
				delete csa;
			csa=NULL;
		}
		else if(result[0]=="load")
		{
			cout<<"not complete yet"<<endl;
		}
		else if(result[0]=="write")
		{
			cout<<"not complete yet"<<endl;
		}
		else if(result[0]=="help")
		{
			if(result[1]=="build")
				helpbuild();
			if(result[1]=="count")
				helpcount();
			if(result[1]=="locate")
				helplocate();
			if(result[1]=="load")
				helpload();
			if(result[1]=="write")
				helpwrite();
		}
		else
			usage();
	}


	return 0;
}
void showpos(int * pos,int num)
{
	cout<<"occs:"<<num<<endl;
	for(int i=0;i<num;i++)
	{
		cout<<pos[i]<<endl;
		if((i+1)%20==0)
		{
			char command;
			cout<<"-----------------more---------------------";
			system("stty raw");
			command=getchar();
     		cout<<endl<<'\r';
			system("stty cooked");
			if(command==27)//按下空格，返回
			{
				cout<<endl;
				return ;
			}
		}
	}
}




void splitcommand(string command,string result[])
{

	int i=0;
	int j=0;
	int start=0;
//	command=command+" ";
	int len=command.length();
	result[0]=command;
	for(i=0;i<len;i++)
	{
		if(command.at(i)!=' ')
			continue;
		else
		{
			result[j]=command.substr(start,i);
			start=i+1;
			j++;
		}
	}
	result[j]=command.substr(start,len);

}
void usage()
{
	cout<<"The flowing commands are supported "<<endl;
	cout<<"	help XX: show the details for the command XX"<<endl;
	cout<<"	build XX: build the index of file XX"<<endl;
	cout<<"	load  XX: load the index file XX"<<endl;
	cout<<"	write XX: write the csa to a index file XX"<<endl;
	cout<<"	count XX: count the pattern XX's occs in the index file YY"<<endl;
	cout<<"	locate YY: enum all the positions of the occs of pattern XX in the index file YY"<<endl;
	cout<<"	del : delete the current csa in the memory"<<endl;
	cout<<"	quit: say goodby"<<endl;

}
void helpbuild()
{
	cout<<"build XX"<<endl;
	cout<<"	XX:the source file,it's you responsibility to provide a correct path"<<endl;
}
void helpcount()
{
	cout<<"count XX"<<endl;
	cout<<"	XX:the pattern.you have the responsibility to ensure the index csa is nearby,otherwise,nothing you will get"<<endl;
}
void helplocate()
{
	cout<<"locate XX"<<endl;
	cout<<"	XX: the pattern.it's like count, and you can scan the positions of all the occs in a manner like the system command -more-"<<endl;
}
void helpload()
{
	cout<<"load XX"<<endl;
	cout<<"	XX: the csa index file, the command will read the index file and build a csa secretly"<<endl;
}
void helpwrite()
{
	cout<<"write XX"<<endl;
	cout<<"	XX: the csa index file, the command will save the csa in file XX"<<endl;
}
